# Руководство по интеграции с СКУД системами

## Обзор

Система управления сотрудниками теперь поддерживает прямое взаимодействие с СКУД (Система Контроля и Управления Доступом) устройствами через IP-адреса. Устройства отправляют данные о проходах сотрудников на сервер, который автоматически обрабатывает эти данные и создает записи рабочего времени.

## Архитектура системы

### Модели данных

1. **SKUDDevice** - СКУД устройства
   - IP адрес и порт для связи
   - Серийный номер устройства
   - Тип устройства (турникет, считыватель, контроллер и т.д.)
   - Местоположение и статус

2. **SKUDEvent** - События от СКУД устройств
   - Время события
   - Тип события (вход/выход/отказ/тревога)
   - Номер карты
   - Связь с сотрудником
   - Исходные данные от устройства

3. **WorkTimeRecord** - Обновленная модель записей рабочего времени
   - Связь с событиями СКУД
   - Автоматический расчет рабочего времени

### API Endpoints

Система предоставляет следующие API endpoints для приема данных от СКУД устройств:

- `POST /api/skud/event/` - Прием событий от устройств
- `GET /api/skud/status/` - Статус системы СКУД
- `GET /api/skud/device/{device_id}/` - Информация об устройстве
- `GET /api/skud/events/` - Получение событий
- `GET /api/skud/health/` - Проверка здоровья системы
- `GET/POST /api/skud/test/` - Тестовый endpoint

## Настройка системы

### 1. Создание миграций и применение к базе данных

```bash
python manage.py makemigrations employees
python manage.py migrate
```

### 2. Добавление СКУД устройств

#### Через админ-панель:
1. Перейдите в админ-панель: http://127.0.0.1:8000/admin/
2. Выберите "СКУД устройства"
3. Нажмите "Добавить СКУД устройство"
4. Заполните поля:
   - **Название**: Описательное имя устройства
   - **IP адрес**: IP адрес устройства в сети
   - **Порт**: Порт для связи (обычно 80)
   - **Серийный номер**: Уникальный серийный номер устройства
   - **Тип устройства**: Турникет, считыватель и т.д.
   - **Местоположение**: Где установлено устройство

#### Через командную строку:
```bash
python manage.py manage_skud_devices add \
  --name "Турникет главный вход" \
  --ip "192.168.1.100" \
  --port 80 \
  --serial "SKUD001" \
  --type turnstile \
  --location "Главный вход"
```

### 3. Настройка СКУД устройства

На СКУД устройстве необходимо настроить:
- **IP адрес сервера**: IP адрес вашего Django сервера
- **Порт**: 8000 (или другой, на котором работает Django)
- **URL для отправки данных**: `http://YOUR_SERVER_IP:8000/api/skud/event/`
- **Формат данных**: JSON (см. раздел "Формат данных")

## Формат данных от СКУД устройств

### Пример JSON запроса для события прохода:

```json
{
  "card_number": "EMP001",
  "event_type": "entry",
  "timestamp": "2024-01-15T09:30:00",
  "direction": "in",
  "device_info": {
    "model": "Turnstile-2000",
    "firmware": "1.2.3"
  }
}
```

### Обязательные поля:
- `card_number` - Номер карты/кода сотрудника
- `event_type` - Тип события: "entry", "exit", "denied", "alarm"

### Опциональные поля:
- `timestamp` - Время события (если не указано, используется время получения)
- `direction` - Направление: "in", "out"
- `device_info` - Дополнительная информация об устройстве

### Типы событий:
- `entry` - Вход сотрудника
- `exit` - Выход сотрудника  
- `denied` - Отказ в доступе
- `alarm` - Тревожное событие

## Управление через командную строку

### Тестирование устройств

```bash
# Тестировать все устройства
python manage.py manage_skud_devices test --all

# Тестировать конкретное устройство
python manage.py manage_skud_devices test --device-id DEVICE_UUID
```

### Синхронизация времени

```bash
# Синхронизировать время всех устройств
python manage.py manage_skud_devices sync-time --all

# Синхронизировать время конкретного устройства
python manage.py manage_skud_devices sync-time --device-id DEVICE_UUID
```

### Получение статуса

```bash
# Статус всех устройств
python manage.py manage_skud_devices status

# Статус конкретного устройства
python manage.py manage_skud_devices status --device-id DEVICE_UUID
```

### Обработка событий

```bash
# Обработать необработанные события
python manage.py manage_skud_devices process-events

# Обработать события за последние 48 часов
python manage.py manage_skud_devices process-events --hours 48
```

### Генерация отчетов

```bash
# Отчет за сегодня
python manage.py manage_skud_devices report

# Отчет за конкретную дату
python manage.py manage_skud_devices report --date 2024-01-15

# Отчет в формате JSON
python manage.py manage_skud_devices report --format json

# Отчет по конкретному устройству
python manage.py manage_skud_devices report --device-id DEVICE_UUID
```

## Работа через админ-панель

### Управление устройствами

1. **Просмотр устройств**: Список всех СКУД устройств с их статусом
2. **Тестирование соединения**: Выберите устройства и нажмите "Тестировать соединение"
3. **Синхронизация времени**: Выберите устройства и нажмите "Синхронизировать время"
4. **Просмотр событий**: В детальном виде устройства показаны последние события

### Управление событиями

1. **Просмотр событий**: Список всех событий от СКУД устройств
2. **Фильтрация**: По типу события, устройству, дате
3. **Обработка событий**: Выберите необработанные события и нажмите "Обработать выбранные события"
4. **Просмотр деталей**: Исходные данные от устройства

### Записи рабочего времени

Записи рабочего времени автоматически создаются и обновляются на основе событий СКУД:
- Время прихода определяется первым событием "entry" за день
- Время ухода определяется последним событием "exit" за день
- Автоматически рассчитывается общее время работы
- Связываются с конкретными событиями СКУД

## Мониторинг и диагностика

### Проверка здоровья системы

```bash
curl http://localhost:8000/api/skud/health/
```

Ответ:
```json
{
  "status": "success",
  "health": {
    "overall_status": "healthy",
    "server_time": "2024-01-15T10:30:00Z",
    "unprocessed_events": 0,
    "total_devices": 5,
    "online_devices": 4,
    "device_health": {
      "192.168.1.100": {
        "device_name": "Турникет главный вход",
        "is_online": true,
        "message": "HTTP соединение успешно",
        "status": "active"
      }
    }
  }
}
```

### Тестирование API

```bash
# Простой тест
curl http://localhost:8000/api/skud/test/

# Тест с отправкой данных
curl -X POST http://localhost:8000/api/skud/test/ \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

### Логирование

Система ведет подробные логи:
- События от СКУД устройств
- Ошибки соединения
- Обработка данных
- Статистика работы

Логи доступны в стандартном Django логгере с именем `employees.skud`.

## Устранение неполадок

### Устройство не отправляет данные

1. Проверьте сетевое соединение:
   ```bash
   ping DEVICE_IP
   ```

2. Проверьте доступность API:
   ```bash
   curl http://DEVICE_IP/api/status
   ```

3. Проверьте настройки устройства (IP сервера, порт, URL)

4. Проверьте логи Django на наличие ошибок

### События не обрабатываются

1. Проверьте необработанные события:
   ```bash
   python manage.py manage_skud_devices process-events
   ```

2. Проверьте связь сотрудника с номером карты:
   - Номер карты должен совпадать с `employee_id` в системе

3. Проверьте формат данных от устройства

### Устройство показывает статус "Ошибка"

1. Проверьте соединение:
   ```bash
   python manage.py manage_skud_devices test --device-id DEVICE_UUID
   ```

2. Проверьте IP адрес и порт устройства
3. Проверьте сетевые настройки
4. Перезагрузите устройство

## Безопасность

### Рекомендации по безопасности:

1. **Сетевая безопасность**:
   - Используйте VPN для связи между устройствами и сервером
   - Настройте файрвол для ограничения доступа
   - Используйте HTTPS для внешних соединений

2. **Аутентификация**:
   - Настройте IP whitelist для устройств
   - Используйте API ключи для аутентификации (можно расширить систему)

3. **Мониторинг**:
   - Регулярно проверяйте логи на подозрительную активность
   - Мониторьте количество событий от каждого устройства

## Расширение функциональности

### Добавление новых типов устройств

1. Обновите `DEVICE_TYPES` в модели `SKUDDevice`
2. Добавьте специфичную логику в `SKUDDeviceCommunicator`
3. Обновите админ-интерфейс при необходимости

### Добавление новых типов событий

1. Обновите `EVENT_TYPES` в модели `SKUDEvent`
2. Добавьте обработку в `_determine_event_type()`
3. Обновите логику обработки событий

### Интеграция с другими системами

Система может быть легко интегрирована с:
- Системами видеонаблюдения
- Системами пожарной безопасности
- HR системами
- Системами расчета заработной платы

## Поддержка

При возникновении проблем:
1. Проверьте логи Django
2. Используйте команды диагностики
3. Проверьте сетевые настройки
4. Обратитесь к документации Django и используемых библиотек
