{% extends 'employees/base.html' %}
{% load static %}

{% block title %}–ê–¥–º–∏–Ω - –¢–µ—Å—Ç PINFL API{% endblock %}

{% block extra_css %}
<style>
    .admin-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
        color: #856404;
    }
    
    .test-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .test-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .test-form {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .test-form input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .test-form button {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .test-form button:hover {
        background: #0056b3;
    }
    
    .result-box {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        margin-top: 1rem;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .success {
        border-left: 4px solid #28a745;
        background: #d4edda;
    }
    
    .error {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
    }
    
    .loading {
        border-left: 4px solid #ffc107;
        background: #fff3cd;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="admin-notice">
        <i class="bi bi-shield-exclamation"></i>
        <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å:</strong> –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Å–∏—Å—Ç–µ–º—ã.
    </div>
    
    <h2>üîß –¢–µ—Å—Ç PINFL API</h2>
    <p class="text-muted">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º API –°–ö–£–î —Å–∏—Å—Ç–µ–º—ã</p>
    
    <div class="test-section">
        <h3>1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
        <div class="test-form">
            <input type="text" id="pinflInput" placeholder="–í–≤–µ–¥–∏—Ç–µ PINFL (–Ω–∞–ø—Ä–∏–º–µ—Ä: 52302017110051)" value="52302017110051">
            <button onclick="testGetEmployee()">–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
        <div id="getResult" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
        <div class="test-form">
            <input type="text" id="syncPinflInput" placeholder="–í–≤–µ–¥–∏—Ç–µ PINFL –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏" value="52302017110051">
            <button onclick="testSyncEmployee()">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="syncResult" class="result-box" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –°–ö–£–î (–ø–æ PINFL)</h3>
        <div class="test-form">
            <input type="text" id="createPinflInput" placeholder="–í–≤–µ–¥–∏—Ç–µ PINFL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" value="12345678901234">
            <button onclick="testCreateEmployee()">–°–æ–∑–¥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
        </div>
        <div id="createResult" class="result-box" style="display: none;"></div>
    </div>
    
    
    <div class="test-section">
        <h3>4. –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ PINFL</h3>
        <div class="test-form">
            <input type="text" id="validateInput" placeholder="–í–≤–µ–¥–∏—Ç–µ PINFL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏" value="123">
            <button onclick="testValidate()">–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div id="validateResult" class="result-box" style="display: none;"></div>
    </div>
</div>

<script>
function showResult(elementId, content, type = 'info') {
    const element = document.getElementById(elementId);
    element.style.display = 'block';
    element.className = `result-box ${type}`;
    element.textContent = content;
}

async function testGetEmployee() {
    const pinfl = document.getElementById('pinflInput').value;
    if (!pinfl) {
        showResult('getResult', '–í–≤–µ–¥–∏—Ç–µ PINFL', 'error');
        return;
    }
    
    showResult('getResult', '–ó–∞–≥—Ä—É–∑–∫–∞...', 'loading');
    
    try {
        const response = await fetch(`/api/pinfl/get/?pinfl=${pinfl}`);
        const data = await response.json();
        
        if (data.success) {
            showResult('getResult', JSON.stringify(data, null, 2), 'success');
        } else {
            showResult('getResult', `–û—à–∏–±–∫–∞: ${data.error}`, 'error');
        }
    } catch (error) {
        showResult('getResult', `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
    }
}

async function testSyncEmployee() {
    const pinfl = document.getElementById('syncPinflInput').value;
    if (!pinfl) {
        showResult('syncResult', '–í–≤–µ–¥–∏—Ç–µ PINFL', 'error');
        return;
    }
    
    showResult('syncResult', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'loading');
    
    try {
        const response = await fetch(`/api/pinfl/sync/?pinfl=${pinfl}`);
        const data = await response.json();
        
        if (data.success) {
            showResult('syncResult', JSON.stringify(data, null, 2), 'success');
        } else {
            showResult('syncResult', `–û—à–∏–±–∫–∞: ${data.error}`, 'error');
        }
    } catch (error) {
        showResult('syncResult', `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
    }
}

async function testCreateEmployee() {
    const pinfl = document.getElementById('createPinflInput').value;
    if (!pinfl) {
        showResult('createResult', '–í–≤–µ–¥–∏—Ç–µ PINFL', 'error');
        return;
    }
    
    showResult('createResult', '–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...', 'loading');
    
    try {
        const response = await fetch(`/api/pinfl/create/?pinfl=${pinfl}`);
        const data = await response.json();
        
        if (data.success) {
            showResult('createResult', JSON.stringify(data, null, 2), 'success');
        } else {
            showResult('createResult', `–û—à–∏–±–∫–∞: ${data.error}`, 'error');
        }
    } catch (error) {
        showResult('createResult', `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
    }
}


async function testValidate() {
    const pinfl = document.getElementById('validateInput').value;
    if (!pinfl) {
        showResult('validateResult', '–í–≤–µ–¥–∏—Ç–µ PINFL', 'error');
        return;
    }
    
    // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    let isValid = false;
    let error = '';
    
    if (!pinfl) {
        error = 'PINFL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º';
    } else if (!pinfl.match(/^\d{14}$/)) {
        error = 'PINFL –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 14 —Ü–∏—Ñ—Ä';
    } else {
        isValid = true;
    }
    
    const result = {
        pinfl: pinfl,
        valid: isValid,
        error: error
    };
    
    showResult('validateResult', JSON.stringify(result, null, 2), isValid ? 'success' : 'error');
}
</script>
{% endblock %}
